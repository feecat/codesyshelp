# 2 基础知识

## 2.1 代码的编译、下载与运行

不同的设备在创建项目时会有不同的附加组件，我们以软件安装时自带的ControlWin举例来展示操作流程。

您应该可以在右下角托盘区看到Control Win SysTray图标 ![](./images/2-1.png) ，单击后选Start PLC，等待三秒左右图标变红 ![](./images/2-2.png) ，即表示已启动。在没有授权的情况下，ControlWin会运行2小时，之后图标自动变灰。

打开codesys软件，新建标准项目，设备选择CODESYS Control Win V3 x64，确认即可。

当您对程序作出修改并登陆时，会提示在线修改。在线修改不会停止PLC，且默认不更新启动应用。如果在线修改过程序且未更新启动应用，则PLC下次重启后仍会运行上一次的启动应用，故建议下载时勾选更新启动应用，或在关机前手动更新启动应用。

## 2.2 设备树与程序树对象

对于程序的大多数操作都在Device选项卡内，可以理解为文件管理器，在里面创建POU程序、Visu、总线等对象。在一个项目中可以有多个Device，一个Device内可以有不同的Application。可以同时登录多个Device，但同一时刻在一个Device内只可以激活一个Application。大多数情况下，我们使用默认的单Device、单Application方案。

在项目上右键可以添加第二个Device，在Device上右键可以添加总线和设备，在PLC Logic上右键可以添加第二个Application，在Application上右键可以添加程序块、visu等元素。

## 2.3 任务的执行过程

任务由运行时按照编译后的二进制文件执行，而二进制文件由项目生成。

所有项目中都有任务管理器（Task Configuration），在其中配置任务。

常用的任务只有两种，周期任务（Cyclic）和无限循环任务（Freewheeling）。

程序块（POU）可以被任务（IEC-Tasks）调用，依附在任务上，任务组按照优先级和循环周期执行，任务组内的不同程序块按照自上而下的顺序执行。在程序中也可以对其它程序调用，和任务处理方式没有区别。

具体到代码中，程序也是自上而下执行的，整个程序执行两遍的间隔即为任务周期。一般来说，单个周期实际执行时间需要1~1000微秒，剩下的时间都是在等待下一个周期。



## 2.4 包、库、设备管理器

后缀名为package的文件为包，其中会包括设备描述、库，有些package还会在菜单中增加一些选项。

后缀名为library或compiled-library的文件为库，有些库是编译后的库不含有源代码（如官方的所有库），有些库含有源代码（oscat库），有些库含有源代码但有加密（私有库，不推荐，加密有破解风险）。

设备管理器分为运行时设备和总线设备，它们都在设备管理器里管理。有些旧版本的codesys需要手动选择文件后缀过滤，否则可能误识别。

当您把项目分发给其他人时，可能会遇到缺库的情况。可以打包为ProjectArchive文件，用相同版本或更高版本IDE打开后所有选项选否，即可自动补全库。
	


## 2.5 占位符和版本管理

库管理器管理库的版本，一般情况下建议根据ide版本设置为最新。当您打开一个较旧或较新的项目时，会提示是否更新库和配置。根据实际情况选择更新到最新版或保持项目版本。若有缺失库的情况，可在库管理器中下载缺失的库。

如果有网络不好或下载不了库的情况，也可以通过占位符手动修改版本号，但大多数情况下推荐用Project-Project Environment来更新版本。

## 2.6 二进制文件与加密

PLC逻辑经过编译后的文件就是二进制文件，该文件只有运行时可以执行。文件格式为app。此外，同目录下还包含crc文件，每次运行时都会进行CRC校验。

与TIA不同的是，CODESYS默认不会上传源代码，只会上传编译后的二进制文件。一般意义上认为二进制文件是无法破解的。而运行时的加密主要防范广域网的攻击而非内部拷贝，所以一般不建议使用运行时加密。

项目文件的加密分为两个等级，一个是项目文件的自身加密，每次打开时需要输入密码。第二个是用户组加密，可以对不同的POU赋予不同的用户组权限，在多人参与维护的程序中非常好用。

