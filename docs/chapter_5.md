# 5 进阶调试

## 5.1 断点、流控制及跟踪

在单片机编程中，断点（Breakpoint）是非常好用的工具，因为单片机资源较少，调试时无法在线显示变量值（会影响单片机运行速度）。而CODESYS可以在线查看程序中的变量实际值，也可以用监视窗口监视多个变量而不影响PLC的运行。此外，断点会导致轴控制急停、总线停止输出等问题，所以在实际应用中很少使用断点进行调试，但在一些For、While循环的调试中仍有必要使用断点。

流控制（Flow Control）可以看到PLC执行是否经过某段代码，不需要去看代码执行条件，经过的代码会被涂色。但可能会导致PLC抖动增加，使用较少。

跟踪（Trace）是最常用的调试功能，相当于时基为依附任务周期的示波器，可以添加多个变量并记录它们的变化过程。一般用于监视CASE的分步、BOOL、REAL、INT变量值等操作。要使用跟踪时，在Application下添加Trace（无论在线与否都可以添加），选择依附的任务，添加变量并下载跟踪即可。

TIP: **跟踪的缓存大小**
在使用跟踪时我们会遇到之前记录的波形被顶掉，这就是缓存大小不足的情况。可以修改trace configuration-Advanced里的Trace editor buffer size per variable大小。

## 5.2 变量的在线操作

在创建总线对象后，如果地址没有被使用的地方，则会按默认优化不显示实际值，此时变量的实际值为灰色，表明该变量不是实际值。要强置设备同步IO，需要在IO映射的右下角选择使能2。

WARNING: **变量的复写**
我们可以对一个变量做赋值，例如iTest默认值为0，我们可以在任意时间对其赋值为2（给定预备值Prepared value，然后使用快捷键CTRL+F7）。但需要注意的是，赋值过程是在一个PLC周期结束后执行，强制赋值是在每一个PLC周期结束后执行。如果代码中有对该变量做写入的操作，则变量显示值与实际值会有不同（复写）。

例如，以下代码中，无论对iTest赋值还是强制赋值，都无法改变iResult的值。

```iecst
VAR
	iTest: INT;
	iResult: INT;
END_VAR

iTest:=2;
iResult:=iTest;
```

复写操作在调试中也经常遇到，我们要尽量避免一个周期内对变量的多个操作，如果在周期开始时对变量写TRUE，周期中间读取了这个变量，周期结束时对这个变量写FALSE，则在监视和TRACE中都无法观察到该变量被写过TRUE的步骤，增加调试难度。

## 5.3 异常和内核转储

CODESYS会自动监控几种异常情况，如除零、无限循环和CPU占用过高等。发生异常后PLC会完全停止在异常点，此时可以用软件登陆上即可看到问题发生的具体代码位置。此外，还可以用内核转储将异常状态存储下来，方便之后复盘问题。

最常见的异常原因为除零，请在做除法运算前用Limit或IF判断，尽量避免异常的发生。此外，引用空指针或错误指针也容易导致异常，编写相关代码时应当小心谨慎。

## 5.4 日志和实时性

日志是检查系统问题的首要位置，您可以在设备页里检查设备日志。某些总线还有独立的日志。
	
## 5.5 系统操作
	
